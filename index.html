<!DOCTYPE html>
<html lang="gl">

<head>
    <meta charset="UTF-8">
    <title>Lista de tarefas</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
</head>

<body class="p-4">

    <h1>Lista de tarefas</h1>

    <table class="table" id="todo-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Completado</th>
                <th>Accións</th>
            </tr>
        </thead>
        <tbody>
            <!-- Filas xeradas por JS -->
        </tbody>
    </table>


    <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id='modal_msg'>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        id='opt_cancel'>Cancelar</button>
                    <button type="button" class="btn btn-primary" id='opt_ok'>Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.min.js" async></script>
    <script src="js/modal.js" defer></script>


    <script>

        const BASE_URL = "http://localhost:8000/api/todos";
        const tableBody = document.querySelector("#todo-table tbody");
        let selectedRow = null;
        let selectedId = null;


        window.onload = function () {
            onceLoaded();
        };
        function onceLoaded() {
            loadTodos();
        }


        function loadTodos() {
             fetch(BASE_URL)
                .then(response => response.json())
                .then(todos => {
                    tableBody.innerHTML = "";

                    todos.data.forEach(todo => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
          <td>${todo.id}</td>
          <td>${todo.title}</td>
          <td>${todo.completed ? "Sí" : "No"}</td>
          <td>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${todo.id}">Eliminar</button>
          </td>
        `;
                        tableBody.appendChild(row);
        });


                        // Escóitaa dos botóns de eliminar
                        tableBody.addEventListener("click", (e) => {
                            if (e.target.classList.contains("delete-btn")) {
                                selectedId = e.target.dataset.id;
                                selectedRow = e.target.closest("tr");
                                showModal("modal", "Confirmación de eliminación", "¿Está seguro de que quiere eliminar este elemento?", null, null, eliminar, null);
                            }
                        });
                    
                }).catch(error => {
                    alert('Ha ocurrido un error obteniendo los elementos');
                    console.log('Ha ocurrido un error obteniendo los elementos' + error)
                });
            }









            function eliminar() {
                if (selectedId) {
                    const res = fetch(`${BASE_URL}/${selectedId}`, { method: "DELETE" })
                        .then(res => {

                            if (res.status === 204) {
                                selectedRow.remove();
                            } else {
                                alert("Erro ao eliminar.");
                            }

                            selectedId = null;
                            selectedRow = null;
                        }).catch(error => {
                            alert('Ocurriu un erro na eliminación: ' + error);
                        })

                }
            }
    </script>



</body>

</html>